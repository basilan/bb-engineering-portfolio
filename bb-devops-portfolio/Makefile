.PHONY: help setup check-setup steel-thread teardown

# Default target
help: ## Show this help message
	@echo "BB DevOps Portfolio - DevOps Reference Implementation"
	@echo "===================================================="
	@echo ""
	@echo "Core targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'
	@echo ""
	@echo "Usage flow:"
	@echo "  make setup â†’ make check-setup â†’ make steel-thread â†’ [prompted] â†’ make teardown"
	@echo ""
	@echo "âš ï¸  IMPORTANT: steel-thread deploys AWS resources that cost money"
	@echo "    Always run teardown after steel-thread to avoid charges"

setup: ## Initialize environment with automated tool installation
	@echo "ğŸš€ BB DevOps Portfolio - Automated Environment Setup"
	@echo "==============================================="
	@echo ""
	@echo "ğŸ”§ Phase 1: Tool Detection and Installation"
	@./scripts/auto-install-tools.sh || { echo "âŒ Tool installation failed - see output above"; exit 1; }
	@echo ""
	@echo "ğŸ”‘ Phase 2: AWS Configuration Validation"
	@AWS_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "AWS_PATH=" | cut -d'"' -f2) && \
		$$AWS_CMD sts get-caller-identity >/dev/null 2>&1 || { \
			echo "âš ï¸  AWS credentials not configured"; \
			echo "Please run: aws configure"; \
			echo "Or set environment variables: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY"; \
			exit 1; \
		}
	@echo "âœ… AWS credentials validated"
	@echo ""
	@echo "ğŸ Phase 3: Python Dependencies"
	@python3 -c "import boto3, pytest, requests, moto" 2>/dev/null || pip3 install --user boto3 pytest requests moto 2>/dev/null || pip3 install --break-system-packages boto3 pytest requests moto
	@echo "âœ… Python dependencies installed"
	@echo ""
	@echo "ğŸ” Phase 4: SSH Key Validation"
	@test -f ~/.ssh/id_rsa.pub || { \
			echo "âš ï¸  SSH key not found - generating new key..."; \
			read -p "Generate new SSH key? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1; \
			ssh-keygen -t rsa -b 4096 -C "bb-devops-portfolio@$$(whoami)" -f ~/.ssh/id_rsa -N ""; \
			echo "âœ… SSH key generated"; \
		} || echo "âœ… SSH key found"
	@echo ""
	@echo "ğŸ“ Phase 5: Terraform Configuration"
	@cd terraform && \
		(test -f terraform.tfvars && echo "ğŸ“ terraform.tfvars exists, skipping creation") || \
		(echo "ğŸ“ Creating terraform.tfvars with real values..." && \
		echo "# Real configuration - created by make setup $$(date)" > terraform.tfvars && \
		echo "aws_region = \"us-east-1\"" >> terraform.tfvars && \
		echo "environment = \"dev\"" >> terraform.tfvars && \
		echo "instance_type = \"t3.micro\"" >> terraform.tfvars && \
		echo "" >> terraform.tfvars && \
		echo "# Your actual SSH public key (auto-generated)" >> terraform.tfvars && \
		printf 'ssh_public_key = "%s"\n' "$$(cat ~/.ssh/id_rsa.pub)" >> terraform.tfvars && \
		echo "" >> terraform.tfvars && \
		echo "# IMPORTANT: Replace with your real email for AWS budget alerts" >> terraform.tfvars && \
		echo "notification_email = \"REPLACE-WITH-YOUR-EMAIL@domain.com\"" >> terraform.tfvars && \
		echo "" >> terraform.tfvars && \
		echo "# Optional: Restrict SSH access to your IP (default allows all)" >> terraform.tfvars && \
		echo "# allowed_cidr_blocks = [\"YOUR.IP.ADDRESS.HERE/32\"]" >> terraform.tfvars)
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD init
	@echo "âœ… Terraform configuration initialized"
	@echo ""
	@echo "âš ï¸  IMPORTANT: Edit terraform/terraform.tfvars and replace REPLACE-WITH-YOUR-EMAIL@domain.com with your real email"
	@echo "âœ… Environment setup complete - ready for steel-thread execution"


check-setup: ## Check all configurations without AWS deployment
	@echo "ğŸ” Quick validation without AWS deployment"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@./scripts/find-tools.sh >/dev/null 2>&1 && echo "âœ… CLI tools detected" || { echo "âŒ Missing tools - see README.md"; exit 1; }
	@cd terraform && terraform validate >/dev/null 2>&1 && echo "âœ… Terraform valid" || { echo "âŒ Terraform failed - see README.md"; exit 1; }
	@ANSIBLE_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "ANSIBLE_PLAYBOOK_PATH=" | cut -d'"' -f2) && $$ANSIBLE_CMD --syntax-check ansible/site.yml >/dev/null 2>&1 && echo "âœ… Ansible valid" || { echo "âŒ Ansible failed - see README.md"; exit 1; }
	@echo "   â†’ Running infrastructure tests..." && python3 -m pytest tests/test_infrastructure.py -q && echo "âœ… Infrastructure tests pass" || { echo "âŒ Infrastructure tests failed"; exit 1; }
	@echo "   â†’ Running configuration tests..." && python3 -m pytest tests/test_configuration.py -q && echo "âœ… Configuration tests pass" || { echo "âŒ Configuration tests failed"; exit 1; }
	@echo ""
	@echo "ğŸ¯ All checks passed - ready for steel-thread demo"

steel-thread: ## Complete end-to-end demo with timestamped logging: deploy â†’ configure â†’ test â†’ show â†’ destroy
	@source ./scripts/steel-thread-logger.sh && initialize_logging
	@echo "ğŸ¯ STEEL-THREAD DEMONSTRATION WITH ENHANCED LOGGING"
	@echo "===================================================="
	@echo "Complete DevOps automation: GitHub Actions â†’ Terraform â†’ Ansible â†’ Testing â†’ Cleanup"
	@echo "Execution logs will be saved to: logs/steel-thread-$$(date +%Y%m%d_%H%M%S).log"
	@echo ""
	@read -p "Deploy live AWS infrastructure for demo? (y/N): " confirm && [ "$$confirm" = "y" ] || { source ./scripts/steel-thread-logger.sh && finalize_logging "cancelled"; exit 1; }
	@echo ""
	@echo "ğŸ” ENTRY: Environment Validation"
	@echo "   â†’ Detecting CLI tools and validating configuration"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		AWS_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "AWS_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD validate >/dev/null 2>&1 && echo "   â†’ Terraform configuration: âœ… VALID" || echo "   â†’ Terraform configuration: âŒ FAILED"
	@AWS_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "AWS_PATH=" | cut -d'"' -f2) && \
		$$AWS_CMD sts get-caller-identity >/dev/null 2>&1 && echo "   â†’ AWS credentials: âœ… AUTHENTICATED" || echo "   â†’ AWS credentials: âŒ FAILED"
	@echo "ğŸ” EXIT: Environment ready for deployment"
	@echo ""
	@echo "ğŸš€ ENTRY: Infrastructure Provisioning (Terraform â†’ AWS)"
	@echo "   â†’ Planning deployment: VPC, EC2, S3, Security Groups, CloudWatch"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD plan -var-file=terraform.tfvars -compact-warnings | grep -E '^(data\.|#|Plan:|Terraform|~|Apply|Error:|Warning:)'
	@echo "   â†’ Provisioning infrastructure: Creating 14 AWS resources"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD apply -var-file=terraform.tfvars -auto-approve
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && WEB_IP=$$($$TERRAFORM_CMD output -raw web_instance_public_ip) && echo "   â†’ Infrastructure provisioned: âœ… COMPLETE (http://$$WEB_IP)"
	@echo "ğŸš€ EXIT: Infrastructure ready for configuration"
	@echo ""
	@echo "   â†’ Instance boot delay: Waiting 60 seconds for EC2 readiness"
	@sleep 60
	@echo ""
	@echo "âš™ï¸ ENTRY: Configuration Management (Ansible)"
	@echo "   â†’ Updating Ansible inventory with actual EC2 IP address"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && WEB_IP=$$($$TERRAFORM_CMD output -raw web_instance_public_ip) && \
		cd ../ansible && \
		sed -i.bak "s/ansible_host: 127.0.0.1/ansible_host: $$WEB_IP/" inventory/hosts.yml && \
		sed -i.bak "s/placeholder:/web1:/" inventory/hosts.yml
	@echo "   â†’ Security hardening: Applying CIS benchmarks, UFW firewall, Fail2Ban protection"
	@ANSIBLE_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "ANSIBLE_PLAYBOOK_PATH=" | cut -d'"' -f2) && \
		cd ansible && $$ANSIBLE_CMD -i inventory/hosts.yml site.yml --limit web --tags security
	@echo "   â†’ Security hardening: âœ… APPLIED"
	@echo "   â†’ Web server setup: Installing Nginx with SSL and security headers"
	@ANSIBLE_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "ANSIBLE_PLAYBOOK_PATH=" | cut -d'"' -f2) && \
		cd ansible && $$ANSIBLE_CMD -i inventory/hosts.yml site.yml --limit web --tags nginx
	@echo "   â†’ Web server setup: âœ… CONFIGURED"
	@echo "   â†’ Monitoring setup: Configuring CloudWatch agent and log rotation"
	@ANSIBLE_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "ANSIBLE_PLAYBOOK_PATH=" | cut -d'"' -f2) && \
		cd ansible && $$ANSIBLE_CMD -i inventory/hosts.yml site.yml --limit web --tags monitoring
	@echo "   â†’ Monitoring setup: âœ… ACTIVE"
	@echo "âš™ï¸ EXIT: Configuration management complete"
	@echo ""
	@echo "âœ… ENTRY: Integration Validation"
	@echo "   â†’ HTTP endpoint testing: Validating web server response and availability"
	@python3 -m pytest tests/test_integration.py::TestIntegration::test_web_server_accessibility -v
	@echo "   â†’ Security header validation: Verifying HTTPS, HSTS, CSP headers"
	@python3 -m pytest tests/test_integration.py::TestIntegration::test_security_headers -v
	@echo "   â†’ Health check validation: Testing monitoring and status endpoints"
	@python3 -m pytest tests/test_integration.py::TestIntegration::test_health_check_endpoint -v
	@echo "âœ… EXIT: System validation complete"
	@echo ""
	@echo "ğŸŒ ENTRY: Live Demonstration"
	@cd terraform && WEB_IP=$$(terraform output -raw web_instance_public_ip) && echo "   â†’ Professional dashboard: http://$$WEB_IP" && echo "   â†’ Monitoring interface: http://$$WEB_IP/monitoring.html" && echo "   â†’ Health check endpoint:" && curl -s "http://$$WEB_IP/health"
	@echo "ğŸŒ EXIT: Demo complete - infrastructure running"
	@echo ""
	@echo "ğŸ‰ STEEL-THREAD COMPLETE!"
	@echo "Real infrastructure accessible at URLs above â†‘"
	@echo ""
	@echo "âš ï¸  CRITICAL: AWS resources are still running and costing money!"
	@echo ""
	@read -p "Run teardown to destroy all AWS resources now? (y/N): " cleanup && \
		if [ "$$cleanup" = "y" ]; then \
			$(MAKE) teardown; \
		else \
			echo ""; \
			echo "âš ï¸  WARNING: Resources still deployed - run 'make teardown' when done"; \
			echo "   â†’ Current charges: EC2 t3.micro (~$$0.0104/hour)"; \
			echo "   â†’ Estimated cost if left running: ~$$0.25/day"; \
			echo ""; \
		fi

teardown: ## Destroy all AWS resources and clean local files
	@echo "ğŸ§¹ ENTRY: Complete Teardown"
	@echo "   â†’ Infrastructure destruction: Destroying all AWS resources (VPC, EC2, S3, etc.)"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD destroy -var-file=terraform.tfvars -auto-approve
	@echo "   â†’ Cleanup verification: Confirming all resources destroyed"
	@TERRAFORM_CMD=$$(./scripts/find-tools.sh 2>/dev/null | grep "TERRAFORM_PATH=" | cut -d'"' -f2) && \
		cd terraform && $$TERRAFORM_CMD state list | wc -l | awk '{if($$1==0) print "   â†’ AWS resources: âœ… ALL DESTROYED"; else print "   â†’ AWS resources: âš ï¸  SOME REMAIN"}'
	@echo "   â†’ Local file cleanup: Removing temporary files"
	@rm -f terraform/tfplan terraform/.terraform.lock.hcl
	@rm -rf terraform/.terraform/ tests/__pycache__/ ansible/retry/
	@rm -f ansible/inventory/hosts.yml.bak
	@echo "   â†’ Local files: âœ… CLEANED"
	@echo "ğŸ§¹ EXIT: Teardown complete"
	@echo ""
	@echo "ğŸ’° Cost verification: AWS resources should show $0.00 charges going forward"
	@echo "ğŸ† Ready for next steel-thread run!"